### 2. 2\~5层网络分别是什么，讲讲每层什么协议，有什么东西

**回答：**

* **数据链路层（L2，帧）**：成帧、MAC 地址、差错检测。
  协议/技术：Ethernet(802.3)、VLAN(802.1Q)、Wi-Fi(802.11) MAC、PPP/PPPoE、ARP(IPv4)、STP/RSTP、LACP、MACsec、MPLS（“二层半”）。
* **网络层（L3，包）**：跨网段寻址与路由。
  协议：IPv4/IPv6、ICMP(v4/v6)、IGMP/MLD（组播）、IPsec；路由：OSPF/IS-IS、BGP、（历史）RIP；NAT/NAPT（功能）。
* **传输层（L4，段/数据报）**：端到端多路复用、可靠性/拥塞。
  协议：TCP、UDP、SCTP、DCCP、QUIC(基于 UDP，内置加密与多路复用)。
* **应用层（L7，报文）**：面向业务语义。
  协议：HTTP/1.1/2/3、DNS、TLS/DTLS、FTP/FTPS/SFTP、SMTP/IMAP/POP3、SSH/Telnet、DHCP、SNMP、NTP、MQTT/AMQP/CoAP、WebSocket、gRPC。

---

### 3. MTU包含哪些层的数据，大小一般多大怎么计算

**回答：**

* **MTU**：链路层一次可承载的**IP 包最大长度**（不含二层头尾）。
* 常见：以太网 **1500**；PPPoE **1492**；数据中心 Jumbo 常 **9000**。
* 计算：

  * IPv4 + TCP：**MSS = MTU − 20(IP) − 20(TCP)**（无选项）；1500→MSS=1460。
  * IPv4 + UDP 载荷：**MTU − 20 − 8**；1500→1472。
  * IPv6 将 IP 头换成 40 字节。

---

### 4. MTU和MSS区别

**回答：**

* **MTU**：链路层能装下的**最大 IP 包**长度（字节）。
* **MSS**：TCP 单段**应用数据**最大长度（字节），握手时协商，通常由 MTU 推导。

---

### 5. TCP怎么保证可靠的

**回答：**

* 序号 + 累积 ACK，按序交付。
* 超时重传（RTO：Retransmission Timeout，重传超时）与快速重传（3 个重复 ACK）。
* 流量控制（接收窗口 rwnd）。
* 拥塞控制（拥塞窗口 cwnd：慢启动、拥塞避免、快速恢复）。
* 校验和、SACK/DSACK 优化恢复。

---

### 6. 建连和断连是怎么样

**回答：**

* **三次握手**：SYN → SYN+ACK → ACK。
* **四次挥手**：FIN → ACK →（对端发完数据）FIN → ACK；主动关闭方进入 **TIME\_WAIT**（2MSL）。

---

### 7. 为什么挥手四次要比握手多一次

**回答：**

* 连接的**两个方向**要独立关闭。被动方可能还有数据要发，所以先 ACK，稍后再发 FIN，自然成为两对报文（共四次）。

---

### 8. 挥手并不是一定得四次，能更少次数怎么做

**回答：**

* 若被动方收到 FIN 时也准备好关闭，可把 **ACK 与自己的 FIN 合并**为 **FIN+ACK**：
  A 发 FIN → B 回 FIN+ACK → A 回 ACK（3 报文完成）。

---

### 9. 既然能更少，为什么主流还是四次

**回答：**

* 实际中双方很少同步完成收尾；先 ACK 再 FIN 能确保数据发完、语义清晰、实现简单稳定，所以默认四次。

---

### 10. 客户端如何知道发送窗口有多大

**回答：**

* **可用发送窗口 ≈ min(rwnd, cwnd) − in\_flight**。

  * rwnd：对端 ACK 中通告的接收窗口（含窗口扩大因子）。
  * cwnd：本端拥塞窗口（算法维护）。
  * in\_flight：已发未确认的字节。
* 系统内核据此限速；可通过 `TCP_INFO` 等接口观测。

---

### 11. 滑动窗口大小如何变化

**回答：**

* **rwnd**：随对端读取速度变化；满了变小，空了变大，可能出现**零窗口探测**。
* **cwnd**：随拥塞控制变化；慢启动指数增，拥塞避免线性增，丢包/拥塞时减小。

---

### 12. 丢包后窗口是否有问题，如何处理

**回答：**

* 丢包被视为拥塞信号（无 ECN 时）：

  * 快速重传：`ssthresh=cwnd/2`，进入快速恢复。
  * RTO：更激进，`cwnd` 降到 1 MSS（或初始值），重新慢启动。
* 打开 **SACK/时间戳** 提升恢复效率；避免路径分片；合理设置 RTO 与算法。

---

### 13. 程序侧如何判断拥塞还是链路随机丢包

**回答：**

* 看**队列延迟**：`q = RTT − minRTT`。先涨 RTT 再丢包→拥塞；RTT 稳而零散丢→随机丢/无线误码。
* 看**丢包形态**：SACK 缺口成簇→拥塞；离散/DSACK 多→乱序/随机丢。
* 结合事件类型（RTO vs 快速重传）与发送速率平台化情况综合判断。

---

### 14. TCP的拥塞控制是怎么做的

**回答：**

* 经典四件套：**慢启动**（指数增）、**拥塞避免**（线性增）、**快速重传**、**快速恢复**（减半后线性增）。
* 现代算法：**CUBIC**（高 BDP 友好），**BBR**（带宽+时延模型，丢包不等于拥塞），**Westwood**（按 ACK 速率估带宽）。

---

### 15. 设计判断拥塞 vs 随机丢包的协议

**回答：**

* 端到端信号：在 ACK 中上报**到达时间统计**（如 q 的滑动均值/斜率）与 **SACK/DSACK** 摘要。
* 分类规则：`q` 上升+簇状丢包→拥塞；`q` 稳+离散丢→随机丢。
* 控制策略：拥塞→乘法减小 cwnd；随机丢→小幅退让+快速恢复，可选**轻量 FEC**。
* 若可改网络：部署 AQM（RED/CoDel/L4S）并保留 ECN 兼容。

---

### 16. 腾讯视频部分视频打不开：从端到云的排查

**回答：**

* **App 端**：清单（m3u8/mpd）是否 200；分片状态码/Range；解码/DRM 授权失败；账号/地区限制；切清晰度、软/硬解、重装/清缓存对比。
* **网络**：

  * DNS 是否解析到异常 POP；IPv4/IPv6 差异；换 DNS 复现。
  * QUIC(UDP/443) 被阻断是否退回 H2(TCP/443)；TLS 握手/证书/SNI 是否异常。
  * PMTU 黑洞：大包丢、无 ICMP；尝试降低 MTU/MSS。
* **服务/CDN**：某 POP 节点 5xx/超时、签名 URL 过期 403、跨区回源慢、特定分片缺失。
* **定位动作**：抓包 + App 日志 + curl 直链验证；更换网络/账号/节点；屏蔽异常 POP；校时与签名；调整 PMTUD/放通 ICMP。

---

### 17. Wireshark 了解吗，手机上如何抓包

**回答：**

* **Android**：`adb shell tcpdump -i any -s 0 -w /sdcard/a.pcap`；或用基于 VPN 的 App（如 PCAPdroid）；HTTP 代理（Charles/Fiddler）+ 安装证书解密。
* **iOS**：`rvictl -s <UDID>` 建立 rvi0，`tcpdump -i rvi0 -w a.pcap`；或使用 HTTP 代理。
* **Wi-Fi 空口**：网卡监控模式抓 802.11，需密钥/握手解密。

---

### 18. 基于抓到的二进制数据如何分析

**回答：**

1. 过滤会话：DNS → TLS/QUIC → HTTP(H2/H3) 或分片请求。
2. 看 **DNS**：IP 是否异常/跨地域。
3. 看 **TLS/QUIC**：握手是否成功、ALPN(`h2`/`h3`)、证书/SNI、Alert；有 keylog 则解密看应用层。
4. 看 **HTTP**：清单 200？分片 200/206/403/404/5xx；Range 是否正确；重定向链路。
5. 看 **传输**：重传/dupACK、窗口、RTT、ECN-CE、RST/FIN。
6. 看 **大小/分片**：是否超过路径 MTU、是否有 ICMP “需要分片”。据此定位到 DNS/CDN/证书/签名/PMTU 等问题。

---

### 19. 抓包的底层原理

**回答：**

* 用户态库 **libpcap/WinPcap/NPcap**，在内核用 **BPF/eBPF** 过滤，合格包放入环形缓冲。
* Linux 常用 **AF\_PACKET + TPACKET**（零拷贝）/NAPI；Windows 依赖 NDIS 驱动。
* 手机 VPN 方案经 **TUN** 设备截取 IP 包；或网卡**混杂模式**/交换机镜像口旁路抓取。

---

### 20. HTTP/1\~3 对比与多路复用在内核如何实现

**回答：**

* **HTTP/1.1**：一个连接一条字节流，易队头阻塞（HoL），靠多连接提高并发。
* **HTTP/2**：在**用户态**把多路流复用到**一条 TCP+TLS** 上；内核只看到一条 TCP 流，TCP 丢包仍造成流间 HoL。
* **HTTP/3**：基于 **QUIC(UDP)**，多路复用在 QUIC 流层（用户态），单个流丢包不阻塞其他流；内核仅处理 UDP，pacing/GSO 协助性能。

---

### 21. QUIC 的可靠与 TCP 可靠的对比

**回答：**

* 都有拥塞/流控；差别在实现层次与粒度。
* **TCP**：内核实现，段级重传，靠 SACK/DSACK；连接绑四元组。
* **QUIC**：用户态实现，帧级重传，ACK 区间更细；**1-RTT 握手**、支持 **0-RTT** 与**连接迁移**（CID）；强制 TLS 1.3 加密。

---

### 22. HTTP 和 HTTPS 区别

**回答：**

* **HTTPS = HTTP over TLS**（常 443）。
* 提供加密、完整性、服务器身份校验（证书），可选客户端证书（mTLS）；支持 HSTS/ALPN。

---

### 23. 讲讲 HTTPS 的完整方案

**回答：**

* **证书与链**：服务器证书＋中间 CA＋根；OCSP/Stapling；自动签发/续期（ACME）。
* **TLS 1.3**：ECDHE、AEAD、PFS；会话票据/PSK，支持 0-RTT（仅幂等）。
* **部署增强**：ALPN(h2/h3)、HSTS、CT（证书透明度）、（可选）ECH、mTLS（内网/支付）。
* **性能**：证书链精简、OCSP stapling、会话复用、CDN 边缘卸载、合理拥塞算法与 pacing。

---

### 24. 这种方案的 RTT 是多少

**回答：**

* **HTTP/2(TCP+TLS1.3)** 新连接：TCP 3WHS **1 RTT** + TLS1.3 **1 RTT** ≈ **2 RTT** 后可发首个请求。
* **HTTP/3(QUIC)** 新连接：**1 RTT** 即可发请求。
* 会话恢复：TLS1.3/QUIC **0-RTT** 可首包携带数据（注意重放风险）。

---

### 25. 有 1RTT 的 HTTPS 方案吗

**回答：**

* 有：**HTTP/3 over QUIC** 新连接 **1-RTT**；恢复可 **0-RTT**。
* 传统 HTTPS 想到 1-RTT 需结合 TFO 等特性，但浏览器与中间盒兼容性一般，主流做法是用 H3。

---

### 26. 网络安全了解多少（DDoS、中间人等）与解决

**回答：**

* **DDoS**（流量/协议/应用层）：Anycast/CDN、清洗中心、速率/连接限制、SYN cookies、自动扩缩容、WAF/JS 挑战、上游黑洞(RTBH)。
* **中间人（MITM）**：伪造 AP、ARP 欺骗、DNS 污染、BGP 劫持。
  防护：TLS1.3+HSTS、严格证书校验/Pinning、DoH/DoT、DNSSEC、RPKI、交换机 DAI。
* **其余**：WAF、mTLS、最小权限、密钥轮换、补丁、审计可观测（日志/NetFlow/eBPF）、攻防演练与应急预案。


下面按机制拆解 **QUIC 如何在 UDP 上实现可靠传输**（基于 RFC 9000/9001/9002 设计要点），尽量用直白表述。

---

## 1) “包 vs 帧”：只重传需要的语义

* **UDP 包**里装多个 **QUIC 帧**（frames）。常见：`STREAM`（应用数据片段，带偏移）、`ACK`、`CRYPTO`（握手数据）、`MAX_DATA`/`MAX_STREAM_DATA`（流量控制）、`PING` 等。
* **丢的是包，补的是帧**：未被确认的 `STREAM/CRYPTO` 帧按其**偏移区间**重发到**新的包号**，不会把旧的 ACK/PADDING 一起重复发送 → **省带宽、快恢复**。

---

## 2) 选择性确认（ACK Ranges）

* 接收端在 **ACK 帧**中回报**一个或多个已收区间**（ranges），等价“超强版 SACK”。
* 发送端据此只重传**缺口**（holes），且能容忍**乱序**，减少误判与冗余重传。
* `ack_delay` 告知接收端延迟确认的时间，用于更准确估计 RTT。

---

## 3) 独立的包号空间

* **Initial / Handshake / 1-RTT** 各有**独立包号空间**与密钥。
* 好处：握手阶段的丢包/重传**不影响**应用阶段的确认与丢包判断，恢复更干净。

---

## 4) 丢包判定与超时（RFC 9002）

* 两条主线：

  1. **包门限阈值（Packet Threshold）**：当某包**之后**的包已被确认且超过一定“重排序阈值”（如 3）仍未确认 → 判定该包丢失，立即重发。
  2. **时间阈值（Time Threshold）**：基于最新 RTT 估算，超出一定倍数仍未被确认 → 判定丢失。
* **PTO（Probe Timeout）**：没有足够 ACK 推进时，按 SRTT/RTTVAR 估算的**探测超时**触发，发送**探测包**（通常含 `PING` + 少量数据/ACK 诱发帧）来**拉起对端 ACK**，避免长时间停滞。

  > 类似 TCP 的 TLP/RTO，但更**积极**、更“细颗粒度”。

---

## 5) 拥塞控制（与 TCP 思想相似）

* 默认 **CUBIC**，也可用 **BBR** 等；同样有 **慢启动/拥塞避免/乘法减小** 等思想。
* **pacing**（限速平滑发送）与 **GSO**（大包分段）降低突发，减少队列抖动。
* **ECN（可选）**：ACK 中回报 ECT/CE 计数；若路径支持，可用 CE 标记作为温和拥塞信号，少靠丢包。

---

## 6) 流量控制：连接级 + 流级

* **两级窗口**：`MAX_DATA`（连接级字节总量）与 `MAX_STREAM_DATA`（单流字节量）。
* 防止某一条流把接收方缓冲**占满**造成死锁；当接收变空，发送方收到新的额度再继续发。
* 辅助帧：`DATA_BLOCKED` / `STREAM_DATA_BLOCKED` 帮助对端知道“我被你的窗口卡住了”。

---

## 7) 多路复用，无队头阻塞（HoL）

* 每个 `STREAM` 独立有**按偏移的有序交付**；某条流的丢包**只影响自己**，不拖慢其他流（区别于 TCP 上的 HTTP/2）。
* 结合帧级重传，使“只补某流缺口”的成本更小。

---

## 8) 握手与加密的可靠性

* **TLS 1.3 集成**在 QUIC 里（`CRYPTO` 帧承载握手消息），握手数据也按帧/偏移可重传。
* 全阶段使用 **AEAD**（加密+完整性校验），并有**头部保护**避免中间盒干扰。
* **Key Update** 支持长连接密钥轮换，持续安全且不打断可靠传输。

---

## 9) 地址验证与放大攻击防护（提升可用性与健壮性）

* 服务器在验证客户端地址前有**放大限制**（最多回发 3 倍字节），降低恶意反射风险。
* **Retry**/Token 验证来源地址，防止伪造导致的“假丢包”。
* 这些机制确保在复杂/恶意环境下连接能**可靠建立与维持**。

---

## 10) 路径与迁移的可靠性

* **Connection ID（CID）** 让连接不绑固定四元组；网络切换（Wi-Fi/蜂窝）不断线。
* 新路径用 **Path Challenge/Response** 做可达验证；失败可回切原路径。
* 对每条路径独立统计 RTT/丢包，避免误用旧路径的拥塞状态。

---

## 11) PMTU 探测（PLPMTUD）

* 主动探测可用**最大不分片报文**，避免“分片黑洞”把大包持续丢掉。
* 探测失败就回退到更小的探测尺寸，稳定后再尝试增大。

---

## 12) 发送调度与优先级

* **CRYPTO > ACK-eliciting STREAM > 控制帧**：握手/恢复优先，尽快拉起确认链。
* **ACK 触发规则**：对“招 ACK 的包”快速回 ACK；否则延迟确认，减少反馈噪声但保持时效。

---

## 13) 出错与收尾：Stateless Reset / CONNECTION\_CLOSE

* 端点崩溃或状态丢失时可发**Stateless Reset** 通知对端尽快清理状态。
* 正常关闭用 `CONNECTION_CLOSE` 携带错误码，语义清晰，避免“无声失败”。

---

## 小结（面试口径）

> **可靠性的核心组合拳**：
> **强选择性确认**（ACK ranges） + **帧级重传**（按偏移补缺） + **双阈值丢包判定 + PTO 探测**（更积极的恢复） + **现代拥塞/流控**（pacing/GSO/ECN/两级窗口） + **独立包号空间**（隔离阶段） + **迁移/PMTUD/地址验证**（抗环境波动）。
> 结果：在 UDP 之上实现**至少等效于 TCP 的可靠性**，并在**握手时延、多路复用、网络迁移**等方面更强。
